(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?t(exports,require("md5"),require("base-64")):typeof define==="function"&&define.amd?define(["exports","md5","base-64"],t):t(e.Airloy=e.Airloy||{},e.md5,e.base64)})(this,function(e,t,r){"use strict";t="default"in t?t["default"]:t;r="default"in r?r["default"]:r;var i=function(){function e(e){this.value=e}function t(t){var r,i;function n(e,t){return new Promise(function(n,o){var a={key:e,arg:t,resolve:n,reject:o,next:null};if(i){i=i.next=a}else{r=i=a;s(e,t)}})}function s(r,i){try{var n=t[r](i);var a=n.value;if(a instanceof e){Promise.resolve(a.value).then(function(e){s("next",e)},function(e){s("throw",e)})}else{o(n.done?"return":"normal",n.value)}}catch(e){o("throw",e)}}function o(e,t){switch(e){case"return":r.resolve({value:t,done:true});break;case"throw":r.reject(t);break;default:r.resolve({value:t,done:false});break}r=r.next;if(r){s(r.key,r.arg)}else{i=null}}this._invoke=n;if(typeof t.return!=="function"){this.return=undefined}}if(typeof Symbol==="function"&&Symbol.asyncIterator){t.prototype[Symbol.asyncIterator]=function(){return this}}t.prototype.next=function(e){return this._invoke("next",e)};t.prototype.throw=function(e){return this._invoke("throw",e)};t.prototype.return=function(e){return this._invoke("return",e)};return{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}();var n=function(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}};var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||false;i.configurable=true;if("value"in i)i.writable=true;Object.defineProperty(e,i.key,i)}}return function(t,r,i){if(r)e(t.prototype,r);if(i)e(t,i);return t}}();var o=function e(t,r,i){if(t===null)t=Function.prototype;var n=Object.getOwnPropertyDescriptor(t,r);if(n===undefined){var s=Object.getPrototypeOf(t);if(s===null){return undefined}else{return e(s,r,i)}}else if("value"in n){return n.value}else{var o=n.get;if(o===undefined){return undefined}return o.call(i)}};var a=function(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof t)}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:false,writable:true,configurable:true}});if(t)Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t};var u=function(e,t){if(!e){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return t&&(typeof t==="object"||typeof t==="function")?t:e};var l=function e(t,r,i,n){var s=Object.getOwnPropertyDescriptor(t,r);if(s===undefined){var o=Object.getPrototypeOf(t);if(o!==null){e(o,r,i,n)}}else if("value"in s&&s.writable){s.value=i}else{var a=s.set;if(a!==undefined){a.call(n,i)}}return i};var f=function e(){n(this,e);this.server="api.asfun.cn";this.useHttps=false;this.apiVersion="v1";this.appKey="Delight";this.appSecret="test"};var c=function(){function e(t){n(this,e);this._identifier=null}s(e,[{key:"getIdentifier",value:function e(){console.error("[airloy] please init Device instance first.");return this._identifier}}]);return e}();function h(e){return new Promise(function(t,r){function i(s,o){try{var a=e[o?"throw":"next"](s)}catch(e){r(e);return}a.done?t(a.value):Promise.resolve(a.value).then(i,n)}function n(e){i(e,1)}i()})}var y=function(){function e(){n(this,e)}s(e,[{key:"getItem",value:function e(t){return h(function*(){console.error("[airloy] please init Store instance first.");return t}())}},{key:"setItem",value:function e(t,r){console.error("[airloy] please init Store instance first.")}},{key:"removeItem",value:function e(t){console.error("[airloy] please init Store instance first.")}}]);return e}();var p=function(){function e(){n(this,e);this.authRequiredEvent="airloy:login";this.logoutEvent="airloy:logout"}s(e,[{key:"on",value:function e(t,r){console.error("[airloy] please init Event instance first.")}},{key:"once",value:function e(t,r){console.error("[airloy] please init Event instance first.")}},{key:"off",value:function e(){for(var t=arguments.length,r=Array(t),i=0;i<t;i++){r[i]=arguments[i]}var n=true;var s=false;var o=undefined;try{for(var a=r[Symbol.iterator](),u;!(n=(u=a.next()).done);n=true){var l=u.value;this._off(l)}}catch(e){s=true;o=e}finally{try{if(!n&&a.return){a.return()}}finally{if(s){throw o}}}}},{key:"_off",value:function e(t){console.error("[airloy] please init Event instance first.")}},{key:"emit",value:function e(t){console.error("[airloy] please init Event instance first.")}}]);return e}();var v="";var d=function(){function e(t){n(this,e);this._airloy=t.airloy;this._passport="11111111-1111-1111-1111-111111111111";this._session="00000000-1111-1111-1111-111111111111";this._address="127.0.0.1";this._logined=false;this._loginTime=0;this.user={}}s(e,[{key:"setup",value:function e(){return h(function*(){this._logined="1"===(yield this._airloy.store.getItem("airloy.user.login.flag"));if(this._logined){this._loginTime=yield this._airloy.store.getItem("airloy.user.login.time");this._passport=yield this._airloy.store.getItem("airloy.user.passport");v=this._makeAuth();console.debug("[airloy] restore auth = "+v);var e=(yield this._airloy.store.getItem("airloy.user.info"))||"{}";console.debug("[airloy] restore user = "+e);this.user=JSON.parse(e)}return this._logined}.call(this))}},{key:"formUser",value:function e(t,r){this._loginTime=(new Date).getTime();return{account:t,password:r,device:this._airloy.device.getIdentifier(),loginTime:this._loginTime}}},{key:"saveUser",value:function e(t){this._savePassport(t.passport);console.debug("[Airloy] get new passport = "+this._passport);v=this._makeAuth();this.user=t;this._logined=true;this._airloy.store.setItem("airloy.user.login.time",""+this._loginTime);this._airloy.store.setItem("airloy.user.info",JSON.stringify(this.user));this._airloy.store.setItem("airloy.user.login.flag","1");return this.user}},{key:"updateUser",value:function e(t){return h(function*(){this.user=t;this._airloy.store.setItem("airloy.user.info",JSON.stringify(this.user))}.call(this))}},{key:"getUser",value:function e(){return this.user}},{key:"authRequest",value:function e(t){t.headers.set("X-Airloy-Api",this._airloy.config.apiVersion);t.headers.set("X-Airloy-App",this._airloy.config.appKey);t.headers.set("X-Airloy-Auth",v);this._session&&t.headers.set("X-Airloy-Token",this._session)}},{key:"updateAuth",value:function e(t,r,i){console.debug("[airloy] update new session = "+t+", address = "+r+", passport = "+i);t&&(this._session=t);r&&(this._address=r);i&&this._savePassport(i);v=this._makeAuth()}},{key:"revokeAuth",value:function e(){console.debug("[airloy] revoke passport = "+this._passport);this._savePassport("");this._airloy.store.setItem("airloy.user.login.flag","0");this._airloy.store.setItem("airloy.user.info","{}");this.user={};this._logined=false}},{key:"logined",value:function e(){return this._logined}},{key:"logout",value:function e(){this.revokeAuth();this._airloy.event.emit(this._airloy.event.logoutEvent)}},{key:"_savePassport",value:function e(t){this._passport=t;this._airloy.store.setItem("airloy.user.passport",this._passport)}},{key:"_makeAuth",value:function e(){console.error("[airloy] please init Auth instance first.")}}]);return e}();function g(e,t){var r=[],i=[],n=0,s=0,o,a="";for(n=0;n<256;n++){r[n]=n;i[n]=t.charCodeAt(n%t.length)}for(n=0;n<256;n++){s=(s+r[n]+i[n])%256;o=r[n];r[n]=r[s];r[s]=o}n=0;s=0;for(var u=0;u<e.length;u++){n=(n+1)%256;s=(s+r[n])%256;o=r[n];r[n]=r[s];r[s]=o;a+=String.fromCharCode(e.charCodeAt(u)^r[(r[n]+r[s])%256])}return a}var _=function(e){a(i,e);function i(){n(this,i);return u(this,(i.__proto__||Object.getPrototypeOf(i)).apply(this,arguments))}s(i,[{key:"_makeAuth",value:function e(){var i=this._address+"`"+this._airloy.device.getIdentifier();var n=t(this._loginTime+this._airloy.config.appSecret);i=g(i,n);var s=this._passport+":"+i;s=r.encode(s);return encodeURIComponent(s)}}]);return i}(d);function m(e,t){if(!e)throw new Error("[airloy] "+t)}var k=function(){function e(t){n(this,e);this._airloy=t.airloy;m(typeof Request!=="undefined","requires a Request for http requests.");m(typeof Promise!=="undefined","requires a Promise polyfill.")}s(e,[{key:"httpGet",value:function e(t,r){return h(function*(){try{var e=r?"?"+this._queryString(r):"";var i=new Request(this._fullUrl(t)+e,{method:"GET",headers:new Headers({Accept:"application/json;charset=UTF-8"})});i.headers.set("Host",this._airloy.config.server);this._airloy.auth.authRequest(i);var n=yield fetch(i);return yield this._responseHandle(n)}catch(e){console.warn("[airloy] http result parsing failed. %o",e);return{success:false,message:e.message,info:e.status}}}.call(this))}},{key:"httpPost",value:function e(t,r){return h(function*(){try{var e=new Request(this._fullUrl(t),{method:"POST",headers:new Headers({Accept:"application/json;charset=UTF-8","Content-Type":"application/json"}),body:JSON.stringify(r)});e.headers.set("Host",this._airloy.config.server);this._airloy.auth.authRequest(e);var i=yield fetch(e);return yield this._responseHandle(i)}catch(e){console.warn("[airloy] http result parsing failed. %o",e);return{success:false,message:e.message,info:e.status}}}.call(this))}},{key:"_fullUrl",value:function e(t){if(t.substr(0,4)==="http"){return t}else{var r=this._airloy.config.useHttps?"https://":"http://";t.substr(0,1)==="/"||(t="/"+t);return r+this._airloy.config.server+t}}},{key:"_queryString",value:function e(t){if(!t)return"";var r=[],i;for(var n in t){if(t.hasOwnProperty(n)){Array.isArray(i=t[n])||(i=[i]);n=n+"=";for(var s=0;s<i.length;s++){r.push(n+encodeURIComponent(i[s]))}}}return r.join("&")}},{key:"_responseHandle",value:function e(t){return h(function*(){switch(t.status){case 201:this._airloy.auth.updateAuth(t.headers.get("X-Airloy-Token"),t.headers.get("X-Airloy-Ip"));case 200:return yield t.json();case 400:return{success:false,message:"error.request.param",info:t.status};case 401:this._airloy.event.emit(this._airloy.event.authRequiredEvent);return{success:false,message:"error.request.auth",info:t.status};case 404:return{success:false,message:"error.data.nofound",info:t.status};case 0:return{success:false,message:"error.network.offline",info:t.status};default:return{success:false,message:"error.network.server",info:t.status}}}.call(this))}}]);return e}();var w={version:"0.9.9",config:new f,device:new c,store:new y,event:new p,auth:null,net:null};function b(e){e.server&&(w.config.server=e.server);w.config.useHttps=e.useHttps?true:false;e.apiVersion&&(w.config.apiVersion=e.apiVersion);e.appKey&&(w.config.appKey=e.appKey);e.appSecret&&(w.config.appSecret=e.appSecret)}function A(e){e.install(w)}var O=new _({airloy:w});var I=new k({airloy:w});w.auth=O;w.net=I;e["default"]=w;e.Device=c;e.Store=y;e.Event=p;e.Auth=d;e.Net=k;e.configure=b;e.use=A;Object.defineProperty(e,"__esModule",{value:true})});